version: '3'

vars:
  PIPELINE_DIR: '{{.ROOT_DIR}}/pipeline'
  OUTPUT_DIR: '{{.ROOT_DIR}}/assets'
  VIEWER_ASSETS: '{{.ROOT_DIR}}/tools/viewer/assets'

tasks:
  build:
    desc: "ğŸš€ Run the complete DAMP build pipeline"
    cmds:
      - echo "ğŸš€ Starting DAMP Build Pipeline..."
      - mkdir -p {{.OUTPUT_DIR}}/models {{.OUTPUT_DIR}}/textures
      - task: geometry
      - task: textures:gen
      - task: sync
      - task: catalog
      - task: verify
      - echo "âœ… DAMP Build Complete."

  geometry:
    desc: "ğŸ“¦ Generate 3D models from Blender source"
    cmds:
      - echo "ğŸ“¦ [1/5] Generating Geometry (Blender)..."
      - blender --background --python {{.PIPELINE_DIR}}/blender/bulldozer.py
    silent: true

  textures:gen:
    desc: "ğŸ¨ Generate procedural textures"
    cmds:
      - echo "ğŸ¨ [2/5] Generating Textures (uv)..."
      - uv run {{.PIPELINE_DIR}}/textures/generate_textures.py
    silent: true

  sync:
    desc: "ğŸšš Sync generated assets to the viewer"
    cmds:
      - echo "ğŸšš [3/5] Syncing Assets to Viewer..."
      - mkdir -p {{.VIEWER_ASSETS}}/textures {{.VIEWER_ASSETS}}/configs
      - cp {{.OUTPUT_DIR}}/models/*.glb {{.VIEWER_ASSETS}}/
      - cp {{.OUTPUT_DIR}}/textures/*.png {{.VIEWER_ASSETS}}/textures/
      - cp {{.OUTPUT_DIR}}/configs/*.json {{.VIEWER_ASSETS}}/configs/
    silent: true

  catalog:
    desc: "ğŸ“– Generate asset catalog"
    cmds:
      - echo "ğŸ“– [4/5] Generating Catalog..."
      - node {{.PIPELINE_DIR}}/scripts/generate-catalog.js
    silent: true

  verify:
    desc: "ğŸ” Verify DAMP contract tags"
    cmds:
      - echo "ğŸ” [5/5] Verifying Contract Tags..."
      - node {{.PIPELINE_DIR}}/scripts/verify-glb.js
    silent: true
