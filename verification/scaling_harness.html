<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scaling Harness</title>
    <!-- Import Map to mock dependencies -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
            "/src/core/graphics.js": "./mocks/graphics.js",
            "/src/core/ui.js": "./mocks/ui.js"
        }
    }
    </script>
    <!-- Matter.js Global -->
    <script src="https://unpkg.com/matter-js@0.19.0/build/matter.min.js"></script>
</head>
<body>
    <div id="status">Loading...</div>
    <script type="module">
        try {
            console.log("Loading modules...");
            // Use absolute paths to trigger the import map correctly
            const { state } = await import('/src/core/state.js');
            const { createBulldozer, getBulldozer } = await import('/src/entities/bulldozer.js');
            const { engine, Runner, Body, Events } = await import('/src/core/physics.js');

            console.log("Modules loaded.");

            // Expose to window for Playwright
            window.state = state;
            window.getBulldozer = getBulldozer;
            window.engine = engine;

            // Initialize Physics Runner
            const runner = Runner.create();
            Runner.run(runner, engine);

            window.runTest = (level) => {
                state.dozerLevel = level;
                state.plowLevel = level;

                createBulldozer();
                const dozer = getBulldozer();

                // Calculate Static Stats
                const mass = dozer.mass;
                const bounds = dozer.bounds;
                const width = bounds.max.x - bounds.min.x;
                const height = bounds.max.y - bounds.min.y;

                return {
                    level,
                    mass,
                    width,
                    height,
                    density: dozer.density
                };
            };

            window.simulateRun = (frames = 300) => {
                const dozer = getBulldozer();
                let maxSpeed = 0;
                let startX = dozer.position.x;
                let startY = dozer.position.y;

                // Reset position
                Body.setPosition(dozer, { x: 0, y: 0 });
                Body.setAngle(dozer, -Math.PI/2);
                Body.setVelocity(dozer, { x: 0, y: 0 });
                Body.setAngularVelocity(dozer, 0);

                // Wait a few frames to settle
                for(let i=0; i<10; i++) {
                    Matter.Engine.update(engine, 1000/60);
                }

                // Updated Power Calculation to match PROPOSED logic in input.js
                // We must ensure this logic MATCHES what we put in input.js
                // Proposed: (0.012 * 1.35^Level) + (Mass * 0.001)
                const power = (0.012 * Math.pow(1.35, state.dozerLevel)) + (dozer.mass * 0.001);

                const forceMag = 1.0 * power;

                for(let i=0; i<frames; i++) {
                    const angle = dozer.angle - Math.PI/2;
                    const force = {
                        x: Math.cos(angle) * forceMag,
                        y: Math.sin(angle) * forceMag
                    };
                    Body.applyForce(dozer, dozer.position, force);
                    Matter.Engine.update(engine, 1000/60);
                    if (dozer.speed > maxSpeed) maxSpeed = dozer.speed;
                }

                const dist = Math.sqrt(
                    Math.pow(dozer.position.x - 0, 2) +
                    Math.pow(dozer.position.y - 0, 2)
                );

                return {
                    maxSpeed,
                    distance: dist
                };
            };

            document.getElementById('status').innerText = "Ready";
            console.log("Harness Ready");
        } catch (e) {
            console.error("Harness Error:", e);
            document.getElementById('status').innerText = "Error: " + e.message;
        }
    </script>
</body>
</html>
