<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #8899aa; font-family: monospace; }
        canvas { display: block; }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        #controls {
            padding: 10px;
            pointer-events: auto;
        }

        button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
        }

        #console-container {
            flex: 1;
            display: none;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            overflow-y: auto;
            pointer-events: auto;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            border-top: 2px solid #555;
            max-height: 50%;
            position: absolute;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .log-error { color: #ff5555; }
        .log-warn { color: #ffff55; }
        .log-info { color: #ffffff; }
    </style>
    <!-- Import Map to resolve 'three' -->
    <script type="importmap">
        {
            "imports": {
                "three": "./node_modules/three/build/three.module.js",
                "three/examples/jsm/": "./node_modules/three/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="ui-layer">
        <div id="controls">
            <button id="toggle-console">Show Logs</button>
            <div style="margin-top: 10px; color: white; background: rgba(0,0,0,0.5); padding: 5px;">
                Touch/Drag to Rotate â€¢ Scroll/Pinch to Zoom
            </div>
        </div>
        <div id="console-container"></div>
    </div>

    <script>
        // On-screen console implementation
        const consoleContainer = document.getElementById('console-container');
        const toggleBtn = document.getElementById('toggle-console');
        let isConsoleOpen = false;

        toggleBtn.addEventListener('click', () => {
            isConsoleOpen = !isConsoleOpen;
            consoleContainer.style.display = isConsoleOpen ? 'block' : 'none';
            toggleBtn.textContent = isConsoleOpen ? 'Hide Logs' : 'Show Logs';
        });

        function appendLog(message, type) {
            const line = document.createElement('div');
            line.className = `log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleContainer.appendChild(line);
            consoleContainer.scrollTop = consoleContainer.scrollHeight;
        }

        // Intercept console methods
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendLog(args.join(' '), 'info');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendLog(args.join(' '), 'warn');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendLog(args.join(' '), 'error');
        };

        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const message = `${msg} (${url}:${lineNo}:${columnNo})`;
            console.error(message);
            return false;
        };

        // Capture resource loading errors
        window.addEventListener('error', (event) => {
            if (event.target && (event.target.tagName === 'SCRIPT' || event.target.tagName === 'IMG' || event.target.tagName === 'LINK')) {
                const url = event.target.src || event.target.href;
                console.error(`Failed to load resource: ${url}`);
            }
        }, true);

        // Catch unhandled promise rejections
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled Rejection: ' + event.reason);
        });

        console.log("Console initialized.");
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        console.log("Three.js imported successfully.");

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x8899aa);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 20, 20); // Better perspective

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Ensure canvas is behind UI
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0';
        renderer.domElement.style.zIndex = '-1';

        // Add Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, 50);
        scene.add(dirLight);

        const loader = new GLTFLoader();
        let loadedModel = null;

        const params = new URLSearchParams(window.location.search);
        // Default to bulldozer if no asset specified
        const asset = params.get('asset') || 'bulldozer.glb';

        console.log(`Attempting to load asset: ${asset}`);

        if (asset) {
            // Load from correct path relative to this file
            const assetPath = `public/assets/${asset}`;
            console.log(`Loading from path: ${assetPath}`);

            loader.load(assetPath, (gltf) => {
                console.log("GLTF Loaded successfully.");
                const mesh = gltf.scene;
                loadedModel = mesh;
                scene.add(mesh);

                // Scale it up if it's too small, or center it
                const box = new THREE.Box3().setFromObject(mesh);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());

                console.log(`Model Size: ${JSON.stringify(size)}`);
                console.log(`Model Center: ${JSON.stringify(center)}`);

                mesh.position.sub(center); // Center at 0,0,0

                controls.target.set(0, 0, 0);
                controls.update();

                // Apply Colors
                let color = 0xCCCCCC; // Default Grey
                if (asset.includes('bulldozer')) color = 0xFFAA00; // Orange/Yellow
                if (asset.includes('plow')) color = 0x888888; // Darker Grey

                // Force material
                mesh.traverse((child) => {
                    if (child.isMesh) {
                        console.log(`Applying color ${color.toString(16)} to mesh`);
                        child.material = new THREE.MeshStandardMaterial({
                            color: color,
                            roughness: 0.7,
                            metalness: 0.3
                        });
                    }
                });

            }, (xhr) => {
                // Progress
            }, (error) => {
                console.error("Error loading model:", error);
                if (error.target && error.target.status) {
                    console.error(`HTTP Status: ${error.target.status} ${error.target.statusText}`);
                }
            });
        }

        window.setAngle = (angleDegrees) => {
            if (loadedModel) {
                loadedModel.rotation.y = angleDegrees * Math.PI / 180;
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
