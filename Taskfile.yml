version: '3'

tasks:
  deps:system:
    desc: Install system dependencies (Blender, Python3-NumPy)
    cmds:
      - task: deps:system:linux
      - task: deps:system:darwin

  deps:system:linux:
    internal: true
    platforms: [linux]
    cmds:
      - echo "Installing system dependencies (Linux)..."
      - sudo apt-get update && sudo apt-get install -y blender python3-numpy
    status:
      - which blender
      - dpkg -s python3-numpy

  deps:system:darwin:
    internal: true
    platforms: [darwin]
    cmds:
      - echo "Installing system dependencies (macOS)..."
      - brew install --cask blender
    status:
      - test -d /Applications/Blender.app

  deps:node:
    desc: Install Node.js dependencies
    cmds:
      - npm install
    sources:
      - package.json
      - package-lock.json
    generates:
      - node_modules/.package-lock.json

  build:assets:
    desc: Build Blender assets (GLB and Textures)
    deps: [deps:system]
    cmds:
      - node scripts/build-blender-assets.js
    sources:
      - assets/source/blender/*.py
    generates:
      - assets/bulldozer_components.glb
      - assets/bulldozer_texture.png

  build:dist:
    desc: Build the production distribution
    deps: [deps:node, build:assets]
    cmds:
      - rm -rf dist
      - mkdir -p dist
      - cp index.html dist/
      - cp style.css dist/
      - cp -r js dist/
      - cp VERSION dist/
      - cp -r assets dist/
      # Copy dependencies
      - mkdir -p dist/node_modules/three/build
      - cp node_modules/three/build/three.module.js dist/node_modules/three/build/
      - mkdir -p dist/node_modules/three/examples
      - cp -r node_modules/three/examples/jsm dist/node_modules/three/examples/
      - mkdir -p dist/node_modules/matter-js/build
      - cp node_modules/matter-js/build/matter.min.js dist/node_modules/matter-js/build/
      - touch dist/.nojekyll
      # Timestamp injection (Linux/GNU sed compatible)
      - sh -c "sed -i \"s/<!--TIMESTAMP-->/$(date -u '+%Y-%m-%d %H:%M')/g\" dist/index.html"

  dev:
    desc: Start the main game server
    deps: [deps:node, build:assets]
    cmds:
      - open http://localhost:3000 || xdg-open http://localhost:3000 || echo "Open http://localhost:3000"
      - npx serve

  viewer:
    desc: Start the asset viewer server
    deps: [deps:node, build:assets]
    cmds:
      - open http://localhost:8000/verification/asset_viewer.html || xdg-open http://localhost:8000/verification/asset_viewer.html || echo "Open http://localhost:8000/verification/asset_viewer.html"
      - python3 -m http.server 8000